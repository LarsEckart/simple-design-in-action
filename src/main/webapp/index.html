<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Todo Lists!</title>
    <style type="text/css" media="screen">
      #error {
        color: black;
        background: pink;
        border-radius: 25px;
        border: 2px solid red;
        padding: 20px;
        box-shadow: 5px 5px 2px #888888;
      }
    </style>
  </head>
  <body>
    <h1>Todo Lists!</h1>
    <p id='error' hidden></p>

    <section id='my-lists-section'>
      <h2>My Lists</h2>
      <a id='new-list-link' href='#'>Create a new list</a>
      <form id='new-list-form' hidden>
        <input type='text' name='name' id='new-list-name'>
        <input type='submit' value='Create this list'>
          or <a id='new-list-cancel' href='#'>Cancel</a>
      </form>

      <ul id='my-lists'></ul>
      <img id='my-lists-spinner' src='/images/spinner.gif' alt='' hidden>
    </section>

    <section id='one-list-section' hidden>
      <h2>NOME DELLA LISTA</h2>
      <ul id='todo-items-unchecked'>
        <li>pippo</li>
      </ul>

      <form id='new-list-form'>
        <input type='text' name='text' id='new-todoitem-text' >
        <br>
        <input type='submit' value='Add this item'>
      </form>

      <ul id='todo-items-checked'>
        <li>pluto</li>
      </ul>
    </section>

    <script src='/scripts/lib/jquery-1.10.2.min.js'></script>
    <script>
    $(document).ready(function() {
      populate_my_lists();
      $('#new-list-link').click(show_new_list_form);
      $('#new-list-cancel').click(hide_new_list_form);
      $('#error').click(hide_error);
      $('#new-list-form').submit(create_new_list);
    });

    function on_error(data) {
      console.log(JSON.stringify(data, null, 2));
      var message = data.statusText;
      if (typeof data.responseJSON !== 'undefined')
        message += ': ' + data.responseJSON.message;
      $('#error').text(message).show();
      hide_my_lists_spinner();
    }

    function hide_error() {
      $('#error').hide(200);
    }

    function create_new_list() {
      show_my_lists_spinner();
      $.ajax({
        url: '/todolists',
        method: 'POST',
        success: on_create_new_list_success,
        error: on_error,
        data: {
          name: $('#new-list-name').val()
        },
      });
      return false;
    }

    function on_create_new_list_success() {
      $('#new-list-name').val("");
      hide_new_list_form();
      populate_my_lists();
    }

    function show_new_list_form() {
      $('#new-list-form').show(200);
    }

    function hide_new_list_form() {
      $('#new-list-form').hide(200);
    }

    function show_my_lists_spinner() {
      $('#my-lists-spinner').show();
    }

    function hide_my_lists_spinner() {
      $('#my-lists-spinner').hide();
    }

    function populate_my_lists() {
      show_my_lists_spinner();
      $.ajax({
        url: '/todolists',
        success: on_populate_my_lists_success,
        error: on_error,
      });
    }

    function on_populate_my_lists_success(data) {
      hide_my_lists_spinner();
      var myLists = data.myLists;
      $('#my-lists').html("");
      for (var i=0; i<myLists.length; i++) {
        var name = myLists[i].name;
        var uri = myLists[i].uri;
        var html = "<li><a href='#' class='todolist' data-uri='" + uri + "'>" + name + "</a></li>";
        $('#my-lists').append(html);
        $('a.todolist').click(open_todolist);
      }
    }

    function open_todolist() {
      show_my_lists_spinner();
      $.ajax({
        url: $(this).attr('data-uri'),
        success: on_open_todolist_success,
        error: on_error,
      });
    }

    function on_open_todolist_success(data) {
      hide_my_lists_spinner();
      $('#my-lists-section').hide();
      $('#one-list-section').show();
      $('#one-list-section h2').text(data.name);
      $('#todo-items-unchecked').html("");
      $('#todo-items-checked').html("");
      for (var i=0; i<data.items.length; i++) {
        var text = data.items[i].text;
        var uri = data.items[i].uri;
        var is_checked = data.items[i].status == "checked";
        var checked_attr = is_checked? "checked" : "";
        var html = "<li><input type='checkbox' " + checked_attr +" class='todoitem'  data-uri='" + uri + "'> " + text + "</li>";
        $('#todo-items-unchecked').append(html);
        $('.todoitem').click(toggle_check);
      }
    }

    function toggle_check() {
      // call Ajax to update the status
      // then reload the todolist
    }

    </script>
  </body>
</html>
